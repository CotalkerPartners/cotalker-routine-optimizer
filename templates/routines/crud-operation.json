{
  "_metadata": {
    "name": "Operaciones CRUD",
    "description": "Template para rutinas que crean, leen, actualizan o eliminan registros segun la accion seleccionada en un formulario. Ejemplos: ABM de entidades, gestion de registros, formularios multi-accion.",
    "triggerType": "survey",
    "variables": {
      "[COMPANY_ID]": "ID de la empresa en Cotalker",
      "[ERROR_CHANNEL]": "ObjectId del canal donde enviar errores",
      "[TASK_CHANNEL]": "ObjectId del canal de la tarea (o usar $VALUE#channel)",
      "[OPERATION_FIELD]": "Identifier del campo del formulario que indica la operacion (crear/leer/actualizar/eliminar)",
      "[MODEL_ID]": "ID del modelo/property type en Cotalker",
      "[RECORD_ID_FIELD]": "Identifier del campo del formulario con el ID del registro (para leer/actualizar/eliminar)",
      "[RECORD_DATA_FIELDS]": "Identifiers de los campos del formulario con los datos del registro (para crear/actualizar)"
    },
    "bestPractices": [
      "Error handler centralizado",
      "next.ERROR en todos los stages criticos",
      "Validacion de entrada como primer stage",
      "Switch para determinar operacion",
      "Soft delete (isActive=false) en lugar de eliminacion fisica",
      "Notificacion de resultado al usuario",
      "Nombres descriptivos en snake_case",
      "_comment en cada stage"
    ]
  },
  "company": "[COMPANY_ID]",
  "isActive": true,
  "maxIterations": 20,
  "surveyTriggers": [
    {
      "triggers": [
        {
          "version": "v3",
          "start": "validate_input",
          "stages": [
            {
              "key": "validate_input",
              "name": "CCJS",
              "_comment": "Valida que los datos del formulario sean correctos y extrae la operacion solicitada",
              "data": {
                "sourceCode": "const data = input.VALUE.data || [];\nconst operationField = data.find(d => d.identifier === '[OPERATION_FIELD]');\nconst operation = operationField && operationField.process ? operationField.process[0].value || operationField.process : null;\nif (!operation) throw new Error('No se especifico la operacion a realizar');\nconst recordIdField = data.find(d => d.identifier === '[RECORD_ID_FIELD]');\nconst recordId = recordIdField && recordIdField.process ? recordIdField.process[0].value || recordIdField.process : null;\nreturn { operation: String(operation), recordId };"
              },
              "next": {
                "OK": "determine_operation",
                "ERROR": "error_handler"
              }
            },
            {
              "key": "determine_operation",
              "name": "FCSwitchOne",
              "_comment": "Enruta al branch correspondiente segun la operacion CRUD seleccionada",
              "data": {
                "lexpression": "$OUTPUT#validate_input#operation",
                "rexpression": "crear",
                "rcaseA": true,
                "rexpressionB": "leer",
                "rcaseB": true,
                "rexpressionC": "actualizar",
                "rcaseC": true,
                "rexpressionD": "eliminar",
                "rcaseD": true
              },
              "next": {
                "CASE_A": "create_record",
                "CASE_B": "read_record",
                "CASE_C": "update_record",
                "CASE_D": "delete_record",
                "DEFAULT": "error_invalid_operation"
              }
            },
            {
              "key": "create_record",
              "name": "NWRequest",
              "_comment": "Crea un nuevo registro en el sistema via API",
              "data": {
                "url": "$JOIN#/#($ENV#BASEURL)#api#v2#properties",
                "method": "POST",
                "headers": {
                  "Authorization": "Bearer $ENV#API_TOKEN",
                  "Content-Type": "application/json"
                },
                "body": {
                  "propertyType": "[MODEL_ID]",
                  "name": "Nuevo registro"
                }
              },
              "next": {
                "OK": "notify_result",
                "ERROR": "error_handler"
              }
            },
            {
              "key": "read_record",
              "name": "NWRequest",
              "_comment": "Lee un registro existente por su ID",
              "data": {
                "url": "$JOIN#/#($ENV#BASEURL)#api#v2#properties#($OUTPUT#validate_input#recordId)",
                "method": "GET",
                "headers": {
                  "Authorization": "Bearer $ENV#API_TOKEN",
                  "Content-Type": "application/json"
                }
              },
              "next": {
                "OK": "notify_result",
                "ERROR": "error_handler"
              }
            },
            {
              "key": "update_record",
              "name": "NWRequest",
              "_comment": "Actualiza un registro existente usando JSON Patch",
              "data": {
                "url": "$JOIN#/#($ENV#BASEURL)#api#v2#properties#($OUTPUT#validate_input#recordId)",
                "method": "PATCH",
                "headers": {
                  "Authorization": "Bearer $ENV#API_TOKEN",
                  "Content-Type": "application/json"
                },
                "body": [
                  {
                    "op": "replace",
                    "path": "/name",
                    "value": "Registro actualizado"
                  }
                ]
              },
              "next": {
                "OK": "notify_result",
                "ERROR": "error_handler"
              }
            },
            {
              "key": "delete_record",
              "name": "NWRequest",
              "_comment": "Soft delete: desactiva el registro estableciendo isActive=false",
              "data": {
                "url": "$JOIN#/#($ENV#BASEURL)#api#v2#properties#($OUTPUT#validate_input#recordId)",
                "method": "PATCH",
                "headers": {
                  "Authorization": "Bearer $ENV#API_TOKEN",
                  "Content-Type": "application/json"
                },
                "body": [
                  {
                    "op": "replace",
                    "path": "/isActive",
                    "value": false
                  }
                ]
              },
              "next": {
                "OK": "notify_result",
                "ERROR": "error_handler"
              }
            },
            {
              "key": "error_invalid_operation",
              "name": "PBMessage",
              "_comment": "Notifica que la operacion solicitada no es valida",
              "data": {
                "channel": "[TASK_CHANNEL]",
                "message": "La operacion solicitada no es valida: $OUTPUT#validate_input#operation\n\nOperaciones permitidas: crear, leer, actualizar, eliminar.",
                "options": {
                  "parse_mode": "Markdown"
                }
              },
              "next": {
                "OK": "end"
              }
            },
            {
              "key": "notify_result",
              "name": "PBMessage",
              "_comment": "Notifica al usuario el resultado exitoso de la operacion",
              "data": {
                "channel": "[TASK_CHANNEL]",
                "message": "**Operacion completada**\n\n**Tipo**: $OUTPUT#validate_input#operation\n**Timestamp**: $TIME#now#*",
                "options": {
                  "parse_mode": "Markdown"
                }
              },
              "next": {
                "OK": "end"
              }
            },
            {
              "key": "error_handler",
              "name": "PBMessage",
              "_comment": "Error handler centralizado - notifica errores al canal de errores",
              "data": {
                "channel": "$ENV#ERROR_CHANNEL",
                "message": "**Error en operacion CRUD**\n\n**Operacion**: $OUTPUT#validate_input#operation\n**Error**: $VALUE#error|message\n**Timestamp**: $TIME#now#*\n\n_Por favor contacte a soporte tecnico._",
                "options": {
                  "parse_mode": "Markdown"
                }
              },
              "next": {
                "OK": "end",
                "ERROR": "end"
              }
            },
            {
              "key": "end",
              "name": "FCSleep",
              "_comment": "Stage final - no-op para terminar la rutina",
              "data": {
                "time": "1"
              }
            }
          ]
        }
      ]
    }
  ]
}
